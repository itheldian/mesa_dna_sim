<!-- templates/sequence_view.html -->

{% extends "base.html" %}
{% block head %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@0.3.0/dist/chartjs-plugin-dragData.min.js"></script>
    <link rel="stylesheet" type="text/css" href={{ url_for('static',filename='styles/overlay.css') }}>
    <!--<link rel="stylesheet" type="text/css" href={{ url_for('static',filename='styles/dropdown.css') }}>-->
    <script src="{{ url_for('static',filename='js/error-chart.js') }}"></script>
    <script src="{{ url_for('static',filename='js/autoscroll.js') }}"></script>
    <script src="{{ url_for('static',filename='js/ajax-api.js') }}"></script>
    <script src="https://unpkg.com/json5@^2.0.0/dist/index.min.js"></script>
{% endblock %}
{% block content %}
    <!--<script type = "text/javascript" >
window.onload = function () {
    document.getElementById("text_lettering").lettering();
}
    </script>-->
    <!--TODO:
    https://stackoverflow.com/questions/43757979/chart-js-drag-points-on-linear-chart
    https://github.com/chrispahm/chartjs-plugin-dragData
    -->
    <div class="control" id="overlay">
        <div class="box control" id="inneroverlay">
            <a href="javascript:void(0)" class="closebtn" onclick="closeOverlay()">&times;</a>
            <div class="box overlay-content" id="overlay-content">
                <canvas id="myChart" width="1600" height="900"></canvas>
            </div>
            <br/>
            <div class="overlay-managebox" id="overlay-managebox">
                <table>
                    <tr>
                        <td>
                            <label class="form-group has-float-label">
                                <input class="input" type="number" id="x-val" placeholder="" size="4" value="15"
                                       required min="0.0" step="1"><span>X-value</span></label></td>
                        <td>
                            <label class="form-group has-float-label">
                                <input class="input" type="number" id="y-val" placeholder="" size="4" value="15"
                                       required min="0.0" step="1"><span>Y-value</span></label></td>
                        <td>
                            <button class="button is-block is-info" type="button" id="addpoint" name="addpoint"
                                    onclick="addPoint($('#x-val').val(), $('#y-val').val());return false;"
                                    data-balloon="Modify is based on X-Value!" data-balloon-pos="up"> Add / Modify point
                            </button>
                        </td>
                        <td>
                            <button class="button is-block is-info" type="button" id="removePoint" name="removePoint"
                                    onclick="removePoint($('#x-val').val());return false;"
                                    data-balloon="Remove is based on X-Value!" data-balloon-pos="up">Remove point
                            </button>
                        </td>
                        <td>
                            <button class="button is-block is-info" type="button" id="setybeforex" name="setybeforex"
                                    onclick="setYValueBeforeX($('#x-val').val(), $('#y-val').val());return false;"
                                    data-balloon="Changes all Y-Values of Points with a smaller X-Value"
                                    data-balloon-pos="up">
                                Set Y-Values before X
                            </button>
                        </td>
                        <td>
                            <button class="button is-block is-info" type="button" id="setyafterx" name="setyafterx"
                                    onclick="setYValueAfterX($('#x-val').val(), $('#y-val').val());return false;"
                                    data-balloon="Changes all Y-Values of Points with a greater X-Value"
                                    data-balloon-pos="up">
                                Set Y-Values after X
                            </button>
                        </td>
                    </tr>
                </table>
                X-Values &lt; 0 will be mapped to the first Y-Value and X-Values &gt; than the maximum X-Value will be
                mapped to the last Y-Value
                <br/>
                <table>
                    <tr>
                        <td>
                            <input class="button is-block is-info" type="button" id="doReset" name="doReset"
                                   onclick="resetChanges();return false;" value="Reset">
                        <td>
                            <input class="button is-block is-info" type="button" id="toogleinterpolation"
                                   name="toogleinterpolation" onclick="toogleCubicInterpolation();return false;"
                                   value="Use Interpolation">
                        </td>
                        <td>
                            <input class="button is-block is-info" type="button" id="toogleDragX"
                                   name="toogleDragX" onclick="toogleDragX();return false;"
                                   value="Allow drag along X-Axis">
                        </td>
                        <td>
                            <label class="form-group has-float-label">
                                <input class="input" type="text" id="chart-name" placeholder="" size="20"
                                       required><span>Name</span></label></td>
                        <td>

                        <td>
                            <button class="button is-block is-info" type="button" id="update-chart" name="update-chart"
                                    onclick="saveChart('{{ host }}', '{{ apikey }}', false);return false;"
                                    data-balloon="Update current Error-Probability Graph" data-balloon-pos="up"> Update
                                Template
                            </button>
                        </td>
                        <td>
                            <button class="button is-block is-info" type="button" id="delete-chart" name="delete-chart"
                                    onclick="deleteChart('{{ host }}', '{{ apikey }}', $('#x-val').val(), $('#y-val').val());return false;"
                                    data-balloon="Delete current Error-Probability Graph" data-balloon-pos="up"> Delete
                            </button>
                        </td>
                        <td>
                            <button class="button is-block is-info" type="button" id="save-chart" name="save-chart"
                                    onclick="saveChart('{{ host }}', '{{ apikey }}', true);return false;"
                                    data-balloon="Save Copy"
                                    data-balloon-pos="up"> Save copy of Template
                            </button>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <script>
        jQuery(document).ready(function () {
            setApikey("{{ host }}", "{{ apikey }}");
            updateDropdown("{{ host }}", "{{ apikey }}", "gc");
            updateDropdown("{{ host }}", "{{ apikey }}", "homopolymer");
            updateDropdown("{{ host }}", "{{ apikey }}", "kmer");

            let chart = $('#myChart');
            chart.dblclick(function (e) {
                //getting value by pressing on dataset
                curr_chart.data.datasets.forEach((dataset) => {
                    for (var scaleName in curr_chart.scales) {
                        var scale = curr_chart.scales[scaleName];
                        if (scale.isHorizontal()) {
                            valueX = Math.max(Math.min(round(scale.getValueForPixel(event.offsetX), xRoundingFactor), maximumX), 0);
                        } else {
                            valueY = Math.max(Math.min(round(scale.getValueForPixel(event.offsetY), yRoundingFactor), maximumY), 0);
                        }
                    }
                    curr_chart.data.datasets.forEach((dataset) => {
                        dataset.data.push({x: valueX, y: valueY});
                    });
                    dataset.data.sort(function (a, b) {
                        return a.x - b.x;
                    });
                    //curr_chart.data.labels.push("tmp");
                });
                removeDuplicatesX();
                curr_chart.update();
            });
            chart.click(function (e) {
                curr_chart.data.datasets.forEach((dataset) => {
                    for (var scaleName in curr_chart.scales) {
                        var scale = curr_chart.scales[scaleName];
                        if (scale.isHorizontal()) {
                            valueX = Math.max(Math.min(round(scale.getValueForPixel(event.offsetX), xRoundingFactor), maximumX), 0);
                        } else {
                            valueY = Math.max(Math.min(round(scale.getValueForPixel(event.offsetY), yRoundingFactor), maximumY), 0);
                        }
                    }
                    $('#x-val').val(valueX);
                    $('#y-val').val(valueY);
                    //curr_chart.data.labels.push("tmp");
                });
            });

            $("body").click(function (event) {
                if (!$(event.target).closest("#inneroverlay,#overlay-content,#showOvrly").length) {
                    closeOverlay();
                }
            });
        });
    </script>
    <h2 class="subtitle">
        Your Query:
    </h2>

    <div class="box">
        <form id="submit_sequence">
            <div class="field">
                <div class="control">
                    <label class="form-group has-float-label">
                    <textarea class="input is-large" rows="5" id="sequence" name="sequence" placeholder="AAACCAGT"
                              required></textarea>
                        <span>Sequence to Analyse</span>
                    </label>
                </div>
            </div>
            <table>
                <tr>
                    <td>
                        <nobr><label for="limitedChars">Limit Alphabet:</label><label class="switch">
                            <input class="switch" type="checkbox" id="limitedChars" checked/>
                            <span class="slider round"></span></label>
                        </nobr>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="form-group has-float-label">
                            <input class="input" type="number" id="gc_window_size" placeholder="" size="4" value="15"
                                   required min="0" step="1"><span>GC Window-Size</span></label>
                    </td>
                    <td>
                        <select id="gc-dropdown">
                            <!--{% for chart in gc_charts %}

                                <option data-id="{{ chart.id }}" data-type="gc"
                                        data-validated="{{ chart.validated }}"
                                        data-isowner="{{ chart.user_id == user_id }}"
                                        data-jsonblob='{{ chart.jsonblob | tojson }}'>{{ chart.name }}</option>
                            {% endfor %}
                            <option data-id="-1" data-type="gc"
                                    data-validated="false" data-isowner="false">New Graph
                            </option>-->
                        </select>
                    </td>
                    <td>
                        <input class="button is-block is-info" type="button" id="showOvrly" name="mybutton"
                               onclick="let dropdown_select = $('#gc-dropdown option:selected');
                               deserializeDataAndLoadDraw(dropdown_select.data('jsonblob'),
                               dropdown_select.data('type'));showOverlay(dropdown_select.data('validated'),
                               dropdown_select.data('isowner'), dropdown_select.data('id'), dropdown_select.text(),
                               dropdown_select.data('type'));"
                               value="Change GC Probability">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="form-group has-float-label">
                            <input class="input" type="number" id="kmer_window_size" placeholder="" size="4" value="15"
                                   required min="0" step="1"><span>Kmer Window-Size</span></label>
                    </td>
                    <td>
                        <select id="kmer-dropdown"></select>
                    </td>
                    <td>
                        <input class="button is-block is-info" type="button" id="showOvrly" name="mybutton"
                               onclick="let dropdown_select = $('#kmer-dropdown option:selected');
                               deserializeDataAndLoadDraw(dropdown_select.data('jsonblob'),
                               dropdown_select.data('type'));showOverlay(dropdown_select.data('validated'),
                               dropdown_select.data('isowner'), dropdown_select.data('id'), dropdown_select.text(),
                               dropdown_select.data('type'));"
                               value="Change Kmer Probability">
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <label for="homopolymer-dropdown"></label><select id="homopolymer-dropdown">
                        <!--{% for chart in homopolymer_charts %}

                                <option data-id="{{ chart.id }}" data-type="homopolymer"
                                        data-validated="{{ chart.validated }}"
                                        data-isowner="{{ chart.user_id == user_id }}"
                                        data-jsonblob='{{ chart.jsonblob | tojson }}'>{{ chart.name }}</option>
                            {% endfor %}
                            <option data-id="-1" data-type="homopolymer"
                                    data-validated="false" data-isowner="false">New Graph
                            </option>-->
                    </select>
                    </td>
                    <td>
                        <input class="button is-block is-info" type="button" id="showOvrly" name="mybutton"
                               onclick="let dropdown_select = $('#homopolymer-dropdown option:selected');
                               deserializeDataAndLoadDraw(dropdown_select.data('jsonblob'),
                               dropdown_select.data('type'));showOverlay(dropdown_select.data('validated'),
                               dropdown_select.data('isowner'), dropdown_select.data('id'), dropdown_select.text(),
                               dropdown_select.data('type'));"
                               value="Change Homopolymer Probability">
                    </td>
                </tr>
            </table>
            <br/>
            <input type="checkbox" id="spoiler"/>
            <label style="white-space: nowrap; display:unset" for="spoiler">Manage Subsequences</label>
            <div class="spoiler">
                <h3>Changes here wont be saved in your profile!</h3>
                <br/>
                <div style="text-align: left">Enabled:</div>
                {% for subsequence in usubsequence %}
                    <div class="control" id="subseq_{{ subsequence.id }}">
                        <table>
                            <tr>
                                <td><label class="switch">
                                    <input class="switch" type="checkbox"
                                           id="enabled"
                                           value="{{ subsequence.id }}" checked/>
                                    <span class="slider round"></span></label>
                                </td>
                                <td style="width:50%"><label class="form-group has-float-label">
                                    <input style="width:100%" type="text" name="sequence" id="sequence" placeholder=""
                                            {% if subsequence.validated %}
                                           readonly{% endif %}
                                           value="{{ subsequence.sequence }}" required>
                                    <span>Sequence</span></label></td>
                                <td style="width:15%"><label class="form-group has-float-label">
                                    <input style="width:100%" type="number" id="error_prob" name="error_prob"
                                           placeholder=""
                                            {% if subsequence.validated %} disabled
                                           readonly {% endif %}
                                           value="{{ subsequence.error_prob }}"
                                           required min="0.0" max="1.0" step="0.01">
                                    <span><nobr>Error Probability</nobr></span></label></td>
                                <td style="width:30%"><label class="form-group has-float-label">
                                    <input style="width:100%" type="text" name="description" id="description"
                                           placeholder="No Description" size="30"
                                            {% if subsequence.validated %}
                                           readonly {% endif %}
                                            {% if subsequence.description != None %}
                                           value="{{ subsequence.description }}"
                                            {% endif %} readonly><span>Description</span></label></td>
                                <!--
                            {% if subsequence.description != None %}
                                Description: {{ subsequence.description }}
                            {% else %}
                                No Description
                            {% endif %}-->
                                <td><span><nobr>Public / Validated: <input type="checkbox" id="validated"
                                                                           value="{{ subsequence.id }}" disabled
                                        {% if subsequence.validated %} checked {% endif %}/></nobr></span></td>
                            </tr>
                        </table>
                        <!--<nobr>
                            Created at:
                            <script>document.write(new Date({{ subsequence.created }} * 1000).toUTCString()
                            )
                            </script>
                        </nobr>-->
                    </div>
                {% endfor %}
            </div>
            <button class="button is-block is-info is-large is-fullwidth">Submit</button>
        </form>
    </div>

    <script type="text/javascript">
        //TODO improve me !

    </script>

    <h2 class="subtitle"> Your Results: </h2>
    <div class="box">
        <h3 class="subtitle" style="color: black"> Homopolymers: </h3>
        <ul class="text_lettering" id="homopolymer" style="overflow-x: auto;"></ul>
    </div>
    <div class="box">
        <h3 class="subtitle" style="color: black"> GC-Content: </h3>
        <ul class="text_lettering" id="gccontent" style="overflow-x: auto;"></ul>
    </div>
    <div class="box">
        <h3 class="subtitle" style="color: black"> Kmer: </h3>
        <ul class="text_lettering" id="kmer" style="overflow-x: auto;"></ul>
    </div>
    <div class="box">
        <h3 class="subtitle" style="color: black"> Subsequences: </h3>
        <div class="text_lettering" id="subsequences" style="overflow-x: auto;"></div>
    </div>
    <div class="box">
        <h3 class="subtitle" style="color: black"> Overall: </h3>
        <ul class="text_lettering" id="overall" style="overflow-x: auto;"></ul>
    </div>

    <!--
    <script>
        $(function () {
            $("#overall").hover(function (e) {
                $(this).find('.overall_char5').css('font-weight', "bold");
            }, function (e) {
                $(this).find('.overall_char5').css('font-weight', "normal");
            });
        })
    </script>
    -->
    <!--{{ apikey }}-->

{% endblock %}