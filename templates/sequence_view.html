<!-- templates/sequence_view.html -->

{% extends "base.html" %}

{% block content %}
    <!--<script type="text/javascript">
        window.onload = function () {
            document.getElementById("text_lettering").lettering();
        }
    </script>-->
    <h2 class="subtitle">
        Your Query:
    </h2>

    <div class="box">
        <form id="submit_sequence">
            <div class="field">
                <div class="control">
                    <textarea class="input is-large" rows="5" id="sequence" type="text" name="sequence"
                              placeholder="AAACCAGT" onkeyup="this.value = this.value.toUpperCase();"
                              required></textarea>
                </div>
            </div>
            <table>
                <td>
                    GC-Content Window-Size:
                </td>
                <td>
                    <input class="input" type="number" id="gc_window_size" placeholder="" size="4" value="15"
                           required
                           min="0" max="10000" step="1">
                </td>
                <td>Kmer Window-Size:</td>
                <td>
                    <input class="input" type="number" id="kmer_window_size" placeholder="" size="4" value="15"
                           required
                           min="0" max="10000" step="1">
    </div>
    </td>
    </table>
    <input type="checkbox" id="spoiler"/>
    <label style="white-space: nowrap;" for="spoiler">Manage Subsequences</label>
    <div class="spoiler">
        <h3>Changes here wont be saved in your profile!</h3>
        {% for subsequence in usubsequence %}
            <div class="control" id="subseq_{{ subsequence.id }}">
                <table>
                    <tr>
                        <td>Enabled: <input type="checkbox" id="enabled"
                                            value="{{ subsequence.id }}" checked/></td>
                        <td><input class="input" type="text" name="sequence"
                                   placeholder="" size="70" {% if subsequence.validated %} disabled {% endif %}
                                   value="{{ subsequence.sequence }}" required></td>
                        <td><input class="input" type="number" name="error_prob"
                                   placeholder="" size="4" {% if subsequence.validated %} disabled {% endif %}
                                   value="{{ subsequence.error_prob }}" required min="0.0" max="1.0"
                                   step="0.01"></td>
                        <td><input class="input" type="text" name="description"
                                   placeholder="No Description" size="30" {% if subsequence.validated %}
                                   disabled {% endif %}
                                {% if subsequence.description != None %}
                                   value="{{ subsequence.description }}"
                                {% endif %} readonly></td>
                        <!--
                            {% if subsequence.description != None %}
                                Description: {{ subsequence.description }}
                            {% else %}
                                No Description
                            {% endif %}-->
                        <td> Public / Validated: <input type="checkbox" id="validated"
                                                        value="{{ subsequence.id }}" disabled
                                {% if subsequence.validated %} checked {% endif %}/></td>
                    </tr>
                </table>
                <!--<nobr>
                            Created at:
                            <script>document.write(new Date({{ subsequence.created }} * 1000).toUTCString()
                            )
                            </script>
                        </nobr>-->

            </div>
        {% endfor %}
    </div>
    <button class="button is-block is-info is-large is-fullwidth">Submit
    </button>
    </form>

    <!--<input type="checkbox" id="spoiler2"/>
    <label style="white-space: nowrap;" for="spoiler2">Change Undesired Sequences</label>
    <div class="spoiler">
        <form id="known_subsequences">
            <div class="field">
                <div class="control">

                </div>
            </div>
        </form>
    </div>
    -->
    </div>
    <script type="text/javascript">
        function extractUndesiredToJson() {
            let res = [];
            $('[id^="subseq_"]').each(function () {
                let enabled = $(this).children().find("[id='enabled']")[0];
                if (enabled.checked) {
                    let id = $(this).children().find("[id='validated']");
                    let sequence = $(this).children().find("[name='sequence']");
                    let error_prob = $(this).children().find("[name='error_prob']");
                    res.push({
                        id: id.val(),
                        sequence: sequence.val(),
                        error_prob: error_prob.val(),
                        enabled: enabled.checked
                    });
                }
            });
            return res;
        }

        function round(value, decimals) {
            return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
        }

        $(document).ready(function () {
            let seq = $("#sequence");
            seq.keypress(function (e) {
                var chr = String.fromCharCode(e.which);
                var limitAlphabet = true;
                if ("ACGTacgt".indexOf(chr) < 0 && limitAlphabet) {
                    return false;
                }
            });
            seq.keydown(function () {
                $(this).val($(this).val().toUpperCase());
            });
            let submit_seq = $("#submit_sequence");
            submit_seq.submit(function (event) {
                event.preventDefault();
                let sequence = $("#sequence").val();
                let homopolymer = $('#homopolymer');
                let gccontent = $('#gccontent');
                let sequences = $('#subsequences');
                let kmer = $('#kmer');
                let overall = $('#overall');
                homopolymer.text(sequence);
                gccontent.text(sequence);
                sequences.text(sequence);
                kmer.text(sequence);
                overall.text(sequence);

                homopolymer.lettering();
                gccontent.lettering();
                sequences.lettering();
                kmer.lettering();
                overall.lettering();

                for (var i = 0; i <= overall.text().length; i++) {
                    let curr_char = $(".overall_char" + (i + 1));
                    curr_char.data('errorprob', 0.0);
                }
                //var endpoints = ['gccontent', 'homopolymers'];

                //for (var mode in endpoints) {
                let endpoints = ["gccontent", "homopolymer", "kmer", "subsequences"];
                endpoints.forEach(function (mode) {
                    $.post({
                        url: "http://{{ host }}/api/" + mode,
                        dataType: 'json',
                        contentType: 'application/json;charset=UTF-8',
                        data: JSON.stringify({
                            sequence: sequence,
                            key: '{{apikey}}',
                            enabledUndesiredSeqs: extractUndesiredToJson(),
                            kmer_windowsize: $('#kmer_window_size').val(),
                            gc_windowsize: $('#gc_window_size').val()
                        }),
                        async: true,
                        beforeSend: function (xhr) {
                            if (xhr && xhr.overrideMimeType) {
                                xhr.overrideMimeType('application/json;charset=utf-8');
                            }
                        },
                        success: function (data) {
                            //$("#spoiler3_label").click();
                            //let obj = jQuery.parseJSON(data);
                            for (block_num in data) {
                                for (var i = data[block_num].startpos; i <= data[block_num].endpos; i++) {
                                    let curr_char = $("." + mode + "_char" + (i + 1));
                                    curr_char.data('errorprob', data[block_num].errorprob);
                                    curr_char.css("background-color", getColorForPercentage(curr_char.data('errorprob')));
                                    curr_char.css("color", "gray");
                                    curr_char.attr('title', (data[block_num].errorprob * 100) + " %");

                                    let overall_curr_char = $(".overall_char" + (i + 1));
                                    overall_curr_char.data('errorprob', round(Math.min(overall_curr_char.data('errorprob') + data[block_num].errorprob, 1.0), 4));
                                    overall_curr_char.css("background-color", getColorForPercentage(overall_curr_char.data('errorprob')));
                                    overall_curr_char.css("color", "gray");
                                    overall_curr_char.attr('title', round((overall_curr_char.data('errorprob') * 100.0), 4) + " %");
                                    //$('#text_lettering').text(data[i].base);
                                }
                            }
                        },
                        fail: function (data) {
                            let obj = jQuery.parseJSON(data);
                            for (var i in obj) {
                                $('#text_lettering').text(data[i].base);
                            }
                            //$('#text_lettering').text(data);
                        }
                    });
                });
                //alert("Handler for .submit() called.");
            });
        });

        var percentColors = [
            {pct: 0.0, color: {r: 0xff, g: 0x00, b: 0}},
            {pct: 0.5, color: {r: 0xff, g: 0xff, b: 0}},
            {pct: 1.0, color: {r: 0x00, g: 0xff, b: 0}}];

        var getColorForPercentage = function (pct) {
            pct = 1.0 - pct;
            for (var i = 1; i < percentColors.length - 1; i++) {
                if (pct < percentColors[i].pct) {
                    break;
                }
            }
            const lower = percentColors[i - 1];
            const upper = percentColors[i];
            const range = upper.pct - lower.pct;
            const rangePct = (pct - lower.pct) / range;
            const pctLower = 1 - rangePct;
            const pctUpper = rangePct;
            const color = {
                r: Math.floor(lower.color.r * pctLower + upper.color.r * pctUpper),
                g: Math.floor(lower.color.g * pctLower + upper.color.g * pctUpper),
                b: Math.floor(lower.color.b * pctLower + upper.color.b * pctUpper)
            };
            return 'rgb(' + [color.r, color.g, color.b].join(',') + ')';
            // or output as hex if preferred
        };

        /*for (var i = 0, l = $('#text_lettering').text().length; i <= l; i++) {
            let curr_char = $(".char" + (i + 1));
            curr_char.css("background-color", getColorForPercentage(i / l));
            curr_char.css("color", "gray");
            curr_char.attr('title', (i / l));
            //$(".text_lettering").append(li);
        }*/
    </script>

    <h2 class="subtitle">
        Your Results:
    </h2>
    <div class="box">
        <h3 class="subtitle" style="color: black">
            Homopolymers:
        </h3>
        <ul class="text_lettering" id="homopolymer" style="overflow-x: auto;"></ul>
    </div>

    <div class="box">
        <h3 class="subtitle" style="color: black">
            GC-Content:
        </h3>
        <ul class="text_lettering" id="gccontent" style="overflow-x: auto;"></ul>
    </div>

    <div class="box">
        <h3 class="subtitle" style="color: black">
            Kmer:
        </h3>
        <ul class="text_lettering" id="kmer" style="overflow-x: auto;"></ul>
    </div>

    <div class="box">
        <h3 class="subtitle" style="color: black">
            Subsequences:
        </h3>
        <ul class="text_lettering" id="subsequences" style="overflow-x: auto;"></ul>
    </div>

    <div class="box">
        <h3 class="subtitle" style="color: black">
            Overall:
        </h3>
        <ul class="text_lettering" id="overall" style="overflow-x: auto;"></ul>
    </div>

    <script type="text/javascript">
        const gccontent = $("#gccontent");
        const homopolymer = $("#homopolymer");
        const kmer = $("#kmer");
        const sequences = $('#subsequences');
        const overall = $('#overall');
        kmer.scroll(function () {
            homopolymer.scrollTop(kmer.scrollTop());
            homopolymer.scrollLeft(kmer.scrollLeft());
            gccontent.scrollTop(kmer.scrollTop());
            gccontent.scrollLeft(kmer.scrollLeft());
            overall.scrollTop(kmer.scrollTop());
            overall.scrollLeft(kmer.scrollLeft());
            sequences.scrollTop(kmer.scrollTop());
            sequences.scrollLeft(kmer.scrollLeft());

        });
        overall.scroll(function () {
            homopolymer.scrollTop(overall.scrollTop());
            homopolymer.scrollLeft(overall.scrollLeft());
            gccontent.scrollTop(overall.scrollTop());
            gccontent.scrollLeft(overall.scrollLeft());
            kmer.scrollTop(overall.scrollTop());
            kmer.scrollLeft(overall.scrollLeft());
            sequences.scrollTop(overall.scrollTop());
            sequences.scrollLeft(overall.scrollLeft());
        });
        gccontent.scroll(function () {
            homopolymer.scrollTop(gccontent.scrollTop());
            homopolymer.scrollLeft(gccontent.scrollLeft());
            overall.scrollLeft(gccontent.scrollLeft());
            overall.scrollTop(gccontent.scrollTop());
            kmer.scrollTop(gccontent.scrollTop());
            kmer.scrollLeft(gccontent.scrollLeft());
            sequences.scrollTop(gccontent.scrollTop());
            sequences.scrollLeft(gccontent.scrollLeft());
        });
        sequences.scroll(function () {
            homopolymer.scrollTop(sequences.scrollTop());
            homopolymer.scrollLeft(sequences.scrollLeft());
            overall.scrollLeft(sequences.scrollLeft());
            overall.scrollTop(sequences.scrollTop());
            kmer.scrollTop(sequences.scrollTop());
            kmer.scrollLeft(sequences.scrollLeft());
            gccontent.scrollTop(sequences.scrollTop());
            gccontent.scrollLeft(sequences.scrollLeft());
        });
        homopolymer.scroll(function () {
            gccontent.scrollTop(homopolymer.scrollTop());
            gccontent.scrollLeft(homopolymer.scrollLeft());
            overall.scrollLeft(homopolymer.scrollLeft());
            overall.scrollTop(homopolymer.scrollTop());
            kmer.scrollTop(homopolymer.scrollTop());
            kmer.scrollLeft(homopolymer.scrollLeft());
            sequences.scrollTop(homopolymer.scrollTop());
            sequences.scrollLeft(homopolymer.scrollLeft());
        });
    </script>
    <!--{{ apikey }}-->

{% endblock %}