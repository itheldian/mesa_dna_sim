<!-- templates/sequence_view.html -->

{% extends "base.html" %}

{% block content %}
    <!--<script type="text/javascript">
        window.onload = function () {
            document.getElementById("text_lettering").lettering();
        }
    </script>-->
    <h2 class="subtitle">
        Your Query:
    </h2>

    <div class="box">
        <form id="submit_sequence">
            <div class="field">
                <div class="control">
                    <label class="form-group has-float-label">
                    <textarea class="input is-large" rows="5" id="sequence" name="sequence" placeholder="AAACCAGT"
                              onkeyup="this.value = this.value.toUpperCase();" required></textarea>
                        <span>Sequence to Analyse</span>
                    </label>
                </div>
            </div>
            <table>
                <td>
                    <label class="form-group has-float-label">
                        <input class="input" type="number" id="gc_window_size" placeholder="" size="4" value="15"
                               required min="0" max="10000" step="1"><span>GC-Content Window-Size</span></label>
                </td>
                <td>
                    <label class="form-group has-float-label">
                        <input class="input" type="number" id="kmer_window_size" placeholder="" size="4" value="15"
                               required min="0" max="10000" step="1"><span>Kmer Window-Size</span></label>
                </td>
            </table>
            <input type="checkbox" id="spoiler"/>
            <label style="white-space: nowrap;" for="spoiler">Manage Subsequences</label>
            <div class="spoiler">
                <h3>Changes here wont be saved in your profile!</h3>
                <br/>
                <div style="text-align: left">Enabled:</div>
                {% for subsequence in usubsequence %}
                    <div class="control" id="subseq_{{ subsequence.id }}">
                        <table>
                            <tr>
                                <td><span><label class="switch">
                                    <input class="switch" type="checkbox"
                                           id="enabled"
                                           value="{{ subsequence.id }}" checked/>
                                    <span class="slider round"></span></label></span>
                                </td>
                                <td><span><label class="form-group has-float-label">
                                    <input type="text" name="sequence" id="sequence" placeholder=""
                                           size="70"
                                            {% if subsequence.validated %}
                                           readonly{% endif %}
                                           value="{{ subsequence.sequence }}" required>
                                    <span>Sequence</span></label></span></td>
                                <td><span><label class="form-group has-float-label">
                                    <input class="balloon" type="number" id="error_prob" name="error_prob"
                                           placeholder="" size="4"
                                            {% if subsequence.validated %} disabled
                                           readonly {% endif %}
                                           value="{{ subsequence.error_prob }}"
                                           required min="0.0" max="1.0" step="0.01">
                                    <span>Error Probability</span></label></span></td>
                                <td><span><label class="form-group has-float-label">
                                    <input class="balloon" type="text" name="description" id="description"
                                           placeholder="No Description" size="30"
                                            {% if subsequence.validated %}
                                           readonly {% endif %}
                                            {% if subsequence.description != None %}
                                           value="{{ subsequence.description }}"
                                            {% endif %} readonly><span>Description</span></label></span></td>
                                <!--
                            {% if subsequence.description != None %}
                                Description: {{ subsequence.description }}
                            {% else %}
                                No Description
                            {% endif %}-->
                                <td><span>Public / Validated: <input type="checkbox" id="validated"
                                                                     value="{{ subsequence.id }}" disabled
                                        {% if subsequence.validated %} checked {% endif %}/></span></td>
                            </tr>
                        </table>
                        <!--<nobr>
                            Created at:
                            <script>document.write(new Date({{ subsequence.created }} * 1000).toUTCString()
                            )
                            </script>
                        </nobr>-->
                    </div>
                {% endfor %}
            </div>
            <button class="button is-block is-info is-large is-fullwidth">Submit</button>
        </form>
    </div>

    <script type="text/javascript">
        //TODO improve me !
        function makeHoverGroups() {
            $('span[class^="group_" ],span[class*=" group_"]').each(function () {
                let cls = $(this).attr('class').split(" ");
                $("." + cls[cls.length - 1]).hover(function () {
                    $("." + cls[cls.length - 1]).css('font-weight', "bold");
                }, function () {
                    $("." + cls[cls.length - 1]).css('font-weight', "normal");
                });
            });
        }

        function extractUndesiredToJson() {
            let res = [];
            $('[id^="subseq_"]').each(function () {
                let enabled = $(this).children().find("[id='enabled']")[0];
                if (enabled.checked) {
                    let id = $(this).children().find("[id='validated']");
                    let sequence = $(this).children().find("[name='sequence']");
                    let error_prob = $(this).children().find("[name='error_prob']");
                    res.push({
                        id: id.val(),
                        sequence: sequence.val(),
                        error_prob: error_prob.val(),
                        enabled: enabled.checked
                    });
                }
            });
            return res;
        }

        function round(value, decimals) {
            return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
        }

        $(document).ready(function () {
            let seq = $("#sequence");
            seq.keypress(function (e) {
                let chr = String.fromCharCode(e.which);
                let limitAlphabet = true;
                if ("ACGTacgt".indexOf(chr) < 0 && limitAlphabet) {
                    return false;
                }
            });
            seq.keydown(function () {
                $(this).val($(this).val().toUpperCase());
            });
            let submit_seq = $("#submit_sequence");
            submit_seq.submit(function (event) {
                event.preventDefault();
                let sequence = $("#sequence").val();
                let homopolymer = $('#homopolymer');
                let gccontent = $('#gccontent');
                let sequences = $('#subsequences');
                let kmer = $('#kmer');
                let overall = $('#overall');
                homopolymer.text(sequence);
                gccontent.text(sequence);
                sequences.text(sequence);
                kmer.text(sequence);
                overall.text(sequence);

                homopolymer.lettering();
                gccontent.lettering();
                sequences.lettering();
                kmer.lettering();
                overall.lettering();

                for (let i = 0; i <= overall.text().length; i++) {
                    let curr_char = $(".overall_char" + (i + 1));
                    curr_char.data('errorprob', 0.0);
                }
                //var endpoints = ['gccontent', 'homopolymers'];

                //for (var mode in endpoints) {

                let endpoints = ["gccontent", "homopolymer", "kmer", "subsequences"];
                endpoints.forEach(function (mode) {
                    $.post({
                        url: "http://{{ host }}/api/" + mode,
                        dataType: 'json',
                        contentType: 'application/json;charset=UTF-8',
                        data: JSON.stringify({
                            sequence: sequence,
                            key: '{{apikey}}',
                            enabledUndesiredSeqs: extractUndesiredToJson(),
                            kmer_windowsize: $('#kmer_window_size').val(),
                            gc_windowsize: $('#gc_window_size').val()
                        }),
                        async: true,
                        beforeSend: function (xhr) {
                            if (xhr && xhr.overrideMimeType) {
                                xhr.overrideMimeType('application/json;charset=utf-8');
                            }
                        },
                        success: function (data) {
                            //$("#spoiler3_label").click();
                            //let obj = jQuery.parseJSON(data);
                            let curr_group = 0;
                            for (let block_num in data) {
                                for (let i = data[block_num].startpos; i <= data[block_num].endpos; i++) {
                                    let curr_char = $("." + mode + "_char" + (i + 1));
                                    curr_char.data('errorprob', Math.min(data[block_num].errorprob, 1.0));
                                    curr_char.css("background-color", getColorForPercentage(curr_char.data('errorprob')));
                                    curr_char.css("color", "gray");
                                    curr_char.attr('title', "Error Probability: " + round(curr_char.data('errorprob') * 100.0, 2) + " %");
                                    curr_char.addClass('group_' + mode + '_' + curr_group);

                                    let overall_curr_char = $(".overall_char" + (i + 1));
                                    overall_curr_char.data('errorprob', Math.min(overall_curr_char.data('errorprob') + data[block_num].errorprob, 1.0));
                                    overall_curr_char.css("background-color", getColorForPercentage(overall_curr_char.data('errorprob')));
                                    overall_curr_char.css("color", "gray");
                                    overall_curr_char.attr('title', "Error Probability: " + round((overall_curr_char.data('errorprob') * 100.0), 2) + " %");
                                    overall_curr_char.addClass('group_' + mode + '_' + curr_group);
                                    //$('#text_lettering').text(data[i].base);
                                }
                                curr_group++;
                            }
                            makeHoverGroups();
                        },
                        fail: function (data) {
                            let obj = jQuery.parseJSON(data);
                            for (let i in obj) {
                                $('#text_lettering').text(data[i].base);
                            }
                            //$('#text_lettering').text(data);
                        }
                    });
                });
                //alert("Handler for .submit() called.");
            });
        });

        const percentColors = [
            {pct: 0.0, color: {r: 0xff, g: 0x00, b: 0}},
            {pct: 0.5, color: {r: 0xff, g: 0xff, b: 0}},
            {pct: 1.0, color: {r: 0x00, g: 0xff, b: 0}}];

        var getColorForPercentage = function (pct) {
            pct = 1.0 - pct;
            for (var i = 1; i < percentColors.length - 1; i++) {
                if (pct < percentColors[i].pct) {
                    break;
                }
            }
            const lower = percentColors[i - 1];
            const upper = percentColors[i];
            const range = upper.pct - lower.pct;
            const rangePct = (pct - lower.pct) / range;
            const pctLower = 1 - rangePct;
            const pctUpper = rangePct;
            const color = {
                r: Math.floor(lower.color.r * pctLower + upper.color.r * pctUpper),
                g: Math.floor(lower.color.g * pctLower + upper.color.g * pctUpper),
                b: Math.floor(lower.color.b * pctLower + upper.color.b * pctUpper)
            };
            return 'rgb(' + [color.r, color.g, color.b].join(',') + ')';
            // or output as hex if preferred
        };

        /*for (var i = 0, l = $('#text_lettering').text().length; i <= l; i++) {
            let curr_char = $(".char" + (i + 1));
            curr_char.css("background-color", getColorForPercentage(i / l));
            curr_char.css("color", "gray");
            curr_char.attr('title', (i / l));
            //$(".text_lettering").append(li);
        }*/
    </script>

    <h2 class="subtitle"> Your Results: </h2>
    <div class="box">
        <h3 class="subtitle" style="color: black"> Homopolymers: </h3>
        <ul class="text_lettering" id="homopolymer" style="overflow-x: auto;"></ul>
    </div>
    <div class="box">
        <h3 class="subtitle" style="color: black"> GC-Content: </h3>
        <ul class="text_lettering" id="gccontent" style="overflow-x: auto;"></ul>
    </div>
    <div class="box">
        <h3 class="subtitle" style="color: black"> Kmer: </h3>
        <ul class="text_lettering" id="kmer" style="overflow-x: auto;"></ul>
    </div>
    <div class="box">
        <h3 class="subtitle" style="color: black"> Subsequences: </h3>
        <ul class="text_lettering" id="subsequences" style="overflow-x: auto;"></ul>
    </div>
    <div class="box">
        <h3 class="subtitle" style="color: black"> Overall: </h3>
        <ul class="text_lettering" id="overall" style="overflow-x: auto;"></ul>
    </div>

    <!--
    <script>
        $(function () {
            $("#overall").hover(function (e) {
                $(this).find('.overall_char5').css('font-weight', "bold");
            }, function (e) {
                $(this).find('.overall_char5').css('font-weight', "normal");
            });
        })
    </script>
    -->

    <script type="text/javascript">
        const gccontent = $("#gccontent");
        const homopolymer = $("#homopolymer");
        const kmer = $("#kmer");
        const sequences = $('#subsequences');
        const overall = $('#overall');
        kmer.scroll(function () {
            homopolymer.scrollTop(kmer.scrollTop());
            homopolymer.scrollLeft(kmer.scrollLeft());
            gccontent.scrollTop(kmer.scrollTop());
            gccontent.scrollLeft(kmer.scrollLeft());
            overall.scrollTop(kmer.scrollTop());
            overall.scrollLeft(kmer.scrollLeft());
            sequences.scrollTop(kmer.scrollTop());
            sequences.scrollLeft(kmer.scrollLeft());

        });
        overall.scroll(function () {
            homopolymer.scrollTop(overall.scrollTop());
            homopolymer.scrollLeft(overall.scrollLeft());
            gccontent.scrollTop(overall.scrollTop());
            gccontent.scrollLeft(overall.scrollLeft());
            kmer.scrollTop(overall.scrollTop());
            kmer.scrollLeft(overall.scrollLeft());
            sequences.scrollTop(overall.scrollTop());
            sequences.scrollLeft(overall.scrollLeft());
        });
        gccontent.scroll(function () {
            homopolymer.scrollTop(gccontent.scrollTop());
            homopolymer.scrollLeft(gccontent.scrollLeft());
            overall.scrollLeft(gccontent.scrollLeft());
            overall.scrollTop(gccontent.scrollTop());
            kmer.scrollTop(gccontent.scrollTop());
            kmer.scrollLeft(gccontent.scrollLeft());
            sequences.scrollTop(gccontent.scrollTop());
            sequences.scrollLeft(gccontent.scrollLeft());
        });
        sequences.scroll(function () {
            homopolymer.scrollTop(sequences.scrollTop());
            homopolymer.scrollLeft(sequences.scrollLeft());
            overall.scrollLeft(sequences.scrollLeft());
            overall.scrollTop(sequences.scrollTop());
            kmer.scrollTop(sequences.scrollTop());
            kmer.scrollLeft(sequences.scrollLeft());
            gccontent.scrollTop(sequences.scrollTop());
            gccontent.scrollLeft(sequences.scrollLeft());
        });
        homopolymer.scroll(function () {
            gccontent.scrollTop(homopolymer.scrollTop());
            gccontent.scrollLeft(homopolymer.scrollLeft());
            overall.scrollLeft(homopolymer.scrollLeft());
            overall.scrollTop(homopolymer.scrollTop());
            kmer.scrollTop(homopolymer.scrollTop());
            kmer.scrollLeft(homopolymer.scrollLeft());
            sequences.scrollTop(homopolymer.scrollTop());
            sequences.scrollLeft(homopolymer.scrollLeft());
        });
    </script>
    <!--{{ apikey }}-->

{% endblock %}