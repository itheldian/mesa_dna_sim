<!-- templates/sequence_view.html -->

{% extends "base.html" %}
{% block head %}
    {{ super() }}
{% endblock %}
{% block content %}
    <!--<script type = "text/javascript" >
window.onload = function () {
    document.getElementById("text_lettering").lettering();
}
    </script>-->
    <!--TODO:
    https://stackoverflow.com/questions/43757979/chart-js-drag-points-on-linear-chart
    https://github.com/chrispahm/chartjs-plugin-dragData
    -->
    <div class="control" id="overlay">
        <div class="box control" id="inneroverlay">
            <a href="javascript:void(0)" class="closebtn" onclick="closeOverlay()">&times;</a>
            <div class="box overlay-all">
                <div class="box overlay-content" id="overlay-content">
                    <canvas id="myChart"></canvas>
                </div>
                <br/>
                <div class="overlay-managebox" id="overlay-managebox">
                    <div class="columns">
                        <div class="column is-pulled-left is-2 is-one-">
                            <label class="form-group has-float-label">
                                <input class="input" type="number" id="x-val" placeholder="" size="4" value="15"
                                       required min="0.0" step="1"><span>X-value</span></label>
                        </div>
                        <div class="column is-pulled-left is-2">
                            <label class="form-group has-float-label">
                                <input class="input" type="number" id="y-val" placeholder="" size="4" value="15"
                                       required min="0.0" step="1"><span>Y-value</span></label>
                        </div>
                        <div class="column is-pulled-left">
                            <button class="button is-block is-info-deactivated button-fill" type="button" id="addpoint"
                                    name="addpoint"
                                    onclick="addPoint($('#x-val').val(), $('#y-val').val());return false;"
                                    data-balloon="Modify is based on X-Value!" data-balloon-pos="up"> Add / Modify point
                            </button>
                        </div>
                        <div class="column is-pulled-left">
                            <button class="button is-block is-info-deactivated button-fill" type="button"
                                    id="removePoint"
                                    name="removePoint" onclick="removePoint($('#x-val').val());return false;"
                                    data-balloon="Remove is based on X-Value!" data-balloon-pos="up">Remove point
                            </button>
                        </div>
                        <div class="column is-pulled-left">
                            <button class="button is-block is-info-deactivated button-fill" type="button"
                                    id="setybeforex"
                                    name="setybeforex"
                                    onclick="setYValueBeforeX($('#x-val').val(), $('#y-val').val());return false;"
                                    data-balloon="Changes all Y-Values of Points with a smaller X-Value"
                                    data-balloon-pos="up">
                                Set Y-Values before X
                            </button>
                        </div>
                        <div class="column is-pulled-left">
                            <button class="button is-block is-info-deactivated button-fill" type="button"
                                    id="setyafterx"
                                    name="setyafterx"
                                    onclick="setYValueAfterX($('#x-val').val(), $('#y-val').val());return false;"
                                    data-balloon="Changes all Y-Values of Points with a greater X-Value"
                                    data-balloon-pos="up">
                                Set Y-Values after X
                            </button>
                        </div>
                    </div>
                    <!--<span>
                    X-Values &lt; 0 will be mapped to the first Y-Value and X-Values &gt; than the maximum X-Value will
                    be mapped to the last Y-Value</span>-->
                    <div class="columns">
                        <div class="column is-pulled-left">
                            <input class="button is-block is-info-deactivated button-fill" type="button" id="doReset"
                                   name="doReset"
                                   onclick="resetChanges();return false;" value="Reset">
                        </div>
                        <div class="column is-pulled-left">
                            <input class="button is-block is-info-deactivated button-fill" type="button"
                                   id="toogleinterpolation"
                                   name="toogleinterpolation" onclick="toogleCubicInterpolation();return false;"
                                   value="Use Interpolation">
                        </div>
                        <div class="column is-pulled-left">
                            <input class="button is-block is-info-deactivated button-fill" type="button"
                                   id="toogleDragX"
                                   name="toogleDragX" onclick="toogleDragX();return false;"
                                   value="Allow drag along X-Axis">
                        </div>
                        <div class="column is-pulled-left is-2">
                            <label class="form-group has-float-label button-fill">
                                <input class="input" type="text" id="chart-name" placeholder="" size="20"
                                       required><span>Name</span></label>
                        </div>
                        <div class="column is-pulled-left">
                            <button class="button is-block is-info-deactivated button-fill" type="button"
                                    id="update-chart"
                                    name="update-chart"
                                    onclick="saveChart('{{ host }}', '{{ apikey }}', false);return false;"
                                    data-balloon="Update current Error-Probability Graph" data-balloon-pos="up"> Update
                                Template
                            </button>
                        </div>
                        <div class="column is-pulled-left">
                            <button class="button is-block is-info-deactivated button-fill" type="button"
                                    id="delete-chart"
                                    name="delete-chart"
                                    onclick="deleteChart('{{ host }}', '{{ apikey }}', $('#x-val').val(), $('#y-val').val());return false;"
                                    data-balloon="Delete current Error-Probability Graph" data-balloon-pos="up"> Delete
                            </button>
                        </div>
                        <div class="column is-pulled-left">
                            <button class="button is-block is-info-deactivated button-fill" type="button"
                                    id="save-chart"
                                    name="save-chart"
                                    onclick="saveChart('{{ host }}', '{{ apikey }}', true);return false;"
                                    data-balloon="Save Copy"
                                    data-balloon-pos="up"> Save copy of Template
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="subtitle">
        Your Query:
    </h2>

    <div class="box">
        <form id="submit_sequence">
            <div class="columns is-gapless is-multiline">
                <div class="column is-1 is-pulled-left">
                    <label data-balloon="Limit Alphabet"
                           data-balloon-pos="up">ACGT only
                        <input type="checkbox" aria-label="Limit Alphabet to ACGT" id="limitedChars" checked
                               class="switch is-rounded is-large button-fill no-outline" name="enableall"/>
                        <label for="limitedChars" class="no-outline"></label>
                    </label>
                </div>
                <div class="column is-pulled-left">
                    <div class="field">
                        <div class="control">
                            <label class="form-group has-float-label">
                    <textarea class="textarea" rows="3" id="sequence" name="sequence" placeholder="AAACCAGT"
                              required></textarea>
                                <span>Sequence to Analyse</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="column is-full">
                </div>
                <div class="column is-1 is-pulled-left">
                    <label class="form-group has-float-label">
                        <input class="input button-fill is-rounded" type="number" id="gc_window_size" placeholder=""
                               size="4"
                               value="15"
                               required min="0" step="1"><span>GC Window</span></label>
                </div>
                <div class="column is-2 is-pulled-left select is-primary is-rounded">
                    <label for="gc-dropdown" aria-label="GC-Method"></label><select class="button-fill"
                                                                                    id="gc-dropdown">
                    <!--{% for chart in gc_charts %}

                                <option data-id="{{ chart.id }}" data-type="gc"
                                        data-validated="{{ chart.validated }}"
                                        data-isowner="{{ chart.user_id == user_id }}"
                                        data-jsonblob='{{ chart.jsonblob | tojson }}'>{{ chart.name }}</option>
                            {% endfor %}
                            <option data-id="-1" data-type="gc"
                                    data-validated="false" data-isowner="false">New Graph
                            </option>-->
                </select>
                </div>
                <div class="column is-2 is-pulled-left">
                    <input class="button is-block button-fill" type="button" id="showOvrly"
                           name="mybutton"
                           onclick="let dropdown_select = $('#gc-dropdown option:selected');
                               deserializeDataAndLoadDraw(dropdown_select.data('jsonblob'),
                               dropdown_select.data('type'));showOverlay(dropdown_select.data('validated'),
                               dropdown_select.data('isowner'), dropdown_select.data('id'), dropdown_select.text(),
                               dropdown_select.data('type'));"
                           value="Change GC Probability">
                </div>
                <div class="column is-4"></div>
                <div class="column is-full">
                </div>
                <div class="column is-1 is-pulled-left">
                    <label class="form-group has-float-label">
                        <input class="input button-fill is-rounded" type="number" id="kmer_window_size" placeholder=""
                               size="4"
                               value="15"
                               required min="0" step="1"><span>Kmer Window</span></label>
                </div>
                <div class="column is-2 is-pulled-left select is-rounded is-primary">
                    <label for="kmer-dropdown" aria-label="Kmer-Method"></label><select class="button-fill"
                                                                                        id="kmer-dropdown"></select>
                </div>
                <div class="column  is-2 is-pulled-left">
                    <input class="button is-block button-fill" type="button" id="showOvrly" name="mybutton"
                           onclick="let dropdown_select = $('#kmer-dropdown option:selected');
                               deserializeDataAndLoadDraw(dropdown_select.data('jsonblob'),
                               dropdown_select.data('type'));showOverlay(dropdown_select.data('validated'),
                               dropdown_select.data('isowner'), dropdown_select.data('id'), dropdown_select.text(),
                               dropdown_select.data('type'));"
                           value="Change Kmer Probability">
                </div>
                <div class="column is-full">
                </div>
                <div class="column is-1 is-pulled-left"></div>
                <div class="column is-2 is-pulled-left select is-rounded is-primary">
                    <label for="homopolymer-dropdown" aria-label="Homopolymer-Method"></label><select
                        class="button-fill" id="homopolymer-dropdown">
                    <!--{% for chart in homopolymer_charts %}

                                <option data-id="{{ chart.id }}" data-type="homopolymer"
                                        data-validated="{{ chart.validated }}"
                                        data-isowner="{{ chart.user_id == user_id }}"
                                        data-jsonblob='{{ chart.jsonblob | tojson }}'>{{ chart.name }}</option>
                            {% endfor %}
                            <option data-id="-1" data-type="homopolymer"
                                    data-validated="false" data-isowner="false">New Graph
                            </option>-->
                </select>
                </div>
                <div class="column is-2 is-pulled-left">
                    <input class="button is-block is-info-deactivated button-fill" type="button" id="showOvrly"
                           name="mybutton"
                           onclick="let dropdown_select = $('#homopolymer-dropdown option:selected');
                               deserializeDataAndLoadDraw(dropdown_select.data('jsonblob'),
                               dropdown_select.data('type'));showOverlay(dropdown_select.data('validated'),
                               dropdown_select.data('isowner'), dropdown_select.data('id'), dropdown_select.text(),
                               dropdown_select.data('type'));"
                           value="Change Homopolymer Prob.">
                </div>
            </div>
            <br/>
            <input type="checkbox" id="spoiler"/>
            <label class="button button-fill" style="white-space: nowrap; display:unset" for="spoiler">Manage
                Subsequences</label>
            <div class="spoiler">
                <h3>Changes here wont be saved in your profile!</h3>
                <br/>
                <div style="text-align: left">Enabled:</div>
                {% for subsequence in usubsequence %}
                    <div class="control" id="subseq_{{ subsequence.id }}">
                        <table>
                            <tr>
                                <td><input type="checkbox"
                                           class="switch is-large is-rounded button-fill no-outline"
                                           id="enabled{{ subsequence.id }}" name="switchRoundedDefault"
                                           aria-label="Enable Rule"
                                           value="{{ subsequence.id }}" checked/>
                                    <label class="no-outline" for="enabled{{ subsequence.id }}"></label>
                                </td>
                                <td style="width:50%"><label class="form-group has-float-label">
                                    <input class="input is-rounded is-grayable" style="width:100%" type="text"
                                           name="sequence"
                                           aria-label="Sequence"
                                           id="sequence" placeholder=""
                                            {% if subsequence.validated %} readonly {% endif %}
                                           value="{{ subsequence.sequence }}" required>
                                    <span>Sequence</span></label></td>
                                <td style="width:15%"><label class="form-group has-float-label">
                                    <input class="input is-rounded is-grayable" style="width:100%" type="number"
                                           id="error_prob"
                                           aria-label="Error Probability"
                                           name="error_prob" placeholder=""
                                            {% if subsequence.validated %} readonly {% endif %}
                                           value="{{ subsequence.error_prob }}"
                                           required min="0.0" max="1.0" step="0.01">
                                    <span><nobr>Error Probability</nobr></span></label></td>
                                <td style="width:30%"><label class="form-group has-float-label">
                                    <input class="input is-rounded is-grayable" style="width:100%" type="text"
                                           name="description"
                                           aria-label="Description"
                                           id="description" placeholder="No Description" size="30"
                                            {% if subsequence.description != None %}
                                           value="{{ subsequence.description }}"
                                            {% endif %} readonly><span>Description</span></label></td>
                                <!--
                            {% if subsequence.description != None %}
                                Description: {{ subsequence.description }}
                            {% else %}
                                No Description
                            {% endif %}-->
                                <td><span class="" style="white-space: nowrap;"><label
                                        class="checkbox">Validated: <input type="checkbox"
                                                                           id="validated_{{ subsequence.id }}"
                                                                           value="{{ subsequence.id }}"
                                                                           aria-label="Validated"
                                                                           disabled
                                        {% if subsequence.validated %} checked {% endif %}/></label></span></td>
                            </tr>
                        </table>
                        <!--<nobr>
                            Created at:
                            <script>document.write(new Date({{ subsequence.created }} * 1000).toUTCString()
                            )
                            </script>
                        </nobr>-->
                    </div>
                {% endfor %}
            </div>
            <button class="button is-block is-info-deactivated is-large is-fullwidth" id="submit_seq_btn">Submit
            </button>
        </form>
    </div>
    <div id="results" style="display: none">
        <h2 class="subtitle"> Your Results: </h2>
        <div class="box">
            <h3 class="subtitle" style="color: black"> Homopolymers: </h3>
            <div class="text_lettering" id="homopolymer" t></div>
        </div>
        <div class="box">
            <h3 class="subtitle" style="color: black"> GC-Content: </h3>
            <div class="text_lettering" id="gccontent"></div>
        </div>
        <div class="box">
            <h3 class="subtitle" style="color: black"> Kmer: </h3>
            <div class="text_lettering" id="kmer"></div>
        </div>
        <div class="box">
            <h3 class="subtitle" style="color: black"> Subsequences: </h3>
            <div class="text_lettering" id="subsequences"></div>
        </div>
        <div class="box">
            <h3 class="subtitle" style="color: black"> Overall: </h3>
            <div class="text_lettering" id="overall"></div>
        </div>
    </div>
    <!--
    <script>
        $(function () {
            $("#overall").hover(function (e) {
                $(this).find('.overall_char5').css('font-weight', "bold");
            }, function (e) {
                $(this).find('.overall_char5').css('font-weight', "normal");
            });
        })
    </script>
    -->
    <!--{{ apikey }}-->

{% endblock %}

{% block javascript %}
    {{ super() }}
    {% if config['DEBUG'] or config['TESTING'] %}
        <script src={{ url_for('static',filename='js/jquery.lettering.js') }}></script>
        <script src={{ url_for('static',filename='js/Chart.min.js') }}></script>
        <script src={{ url_for('static',filename='js/chartjs-plugin-dragData.min.js') }}></script>
        <script src={{ url_for('static',filename='js/error-chart.js') }}></script>
        <script src={{ url_for('static',filename='js/autoscroll.js') }}></script>
        <script src={{ url_for('static',filename='js/ajax-api.js') }}></script>
        <script src={{ url_for('static',filename='js/index.min.js') }}></script>
    {% endif %}

    <script>
        jQuery(document).ready(function () {
            setApikey("{{ host }}", "{{ apikey }}");
            updateDropdown("{{ host }}", "{{ apikey }}", "gc");
            updateDropdown("{{ host }}", "{{ apikey }}", "homopolymer");
            updateDropdown("{{ host }}", "{{ apikey }}", "kmer");

            $(document).keyup(function (e) {
                if (e.keyCode === 27) closeOverlay();
            });

            let chart = $('#myChart');
            chart.dblclick(function (e) {
                //getting value by pressing on dataset
                curr_chart.data.datasets.forEach((dataset) => {
                    for (var scaleName in curr_chart.scales) {
                        var scale = curr_chart.scales[scaleName];
                        if (scale.isHorizontal()) {
                            valueX = Math.max(Math.min(round(scale.getValueForPixel(event.offsetX), xRoundingFactor), maximumX), 0);
                        } else {
                            valueY = Math.max(Math.min(round(scale.getValueForPixel(event.offsetY), yRoundingFactor), maximumY), 0);
                        }
                    }
                    curr_chart.data.datasets.forEach((dataset) => {
                        dataset.data.push({x: valueX, y: valueY});
                    });
                    dataset.data.sort(function (a, b) {
                        return a.x - b.x;
                    });
                    //curr_chart.data.labels.push("tmp");
                });
                removeDuplicatesX();
                curr_chart.update();
            });
            chart.click(function (e) {
                curr_chart.data.datasets.forEach((dataset) => {
                    for (var scaleName in curr_chart.scales) {
                        var scale = curr_chart.scales[scaleName];
                        if (scale.isHorizontal()) {
                            valueX = Math.max(Math.min(round(scale.getValueForPixel(event.offsetX), xRoundingFactor), maximumX), 0);
                        } else {
                            valueY = Math.max(Math.min(round(scale.getValueForPixel(event.offsetY), yRoundingFactor), maximumY), 0);
                        }
                    }
                    $('#x-val').val(valueX);
                    $('#y-val').val(valueY);
                    //curr_chart.data.labels.push("tmp");
                });
            });

            $("body").click(function (event) {
                if (!$(event.target).closest("#inneroverlay,#overlay-content,#showOvrly").length) {
                    closeOverlay();
                }
            });
        });
    </script>
{% endblock %}