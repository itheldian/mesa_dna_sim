<!-- templates/sequence_view.html -->

{% extends "base.html" %}

{% block content %}
    <!--<script type="text/javascript">
        window.onload = function () {
            document.getElementById("text_lettering").lettering();
        }
    </script>-->
    <h2 class="subtitle">
        Your Query:
    </h2>

    <div class="box">
        <form id="submit_sequence">
            <div class="field">
                <div class="control">
                    <textarea class="input is-large" id="sequence" type="text" name="sequence"
                              placeholder="AAACCAGT" onkeyup="this.value = this.value.toUpperCase();"
                              required></textarea>
                </div>
            </div>
            <button class="button is-block is-info is-large is-fullwidth">Submit
            </button>
        </form>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            let seq = $("#sequence");
            seq.keypress(function (e) {
                var chr = String.fromCharCode(e.which);
                var limitAlphabet = true;
                if ("ACGTacgt".indexOf(chr) < 0 && limitAlphabet) {
                    return false;
                }
            });
            seq.keydown(function () {
                $(this).val($(this).val().toUpperCase());
            });
            let submit_seq = $("#submit_sequence");
            submit_seq.submit(function (event) {
                event.preventDefault();
                let sequence = $("#sequence").val();
                $('#text_lettering').text(sequence);
                $('#gccontent').text(sequence);
                //var endpoints = ['gccontent', 'homopolymers'];

                //for (var mode in endpoints) {
                mode = "gccontent";
                $.post({
                    url: "http://0.0.0.0:5000/api/" + mode,
                    data: {sequence: sequence, key: '{{apikey}}', 'window': 15},
                    async: true,
                    beforeSend: function (xhr) {
                        if (xhr && xhr.overrideMimeType) {
                            xhr.overrideMimeType('application/json;charset=utf-8');
                        }
                    },
                    dataType: 'json',
                    success: function (data) {
                        //let obj = jQuery.parseJSON(data);
                        $(".text_lettering").lettering();
                        for (block_num in data) {
                            for (i = data[block_num].startpos; i <= data[block_num].endpos; i++) {
                                let curr_char = $("." + mode + "_char" + (i + 1));
                                curr_char.css("background-color", getColorForPercentage(data[block_num].errorprob));
                                curr_char.css("color", "gray");
                                curr_char.attr('title', (data[block_num].errorprob * 100) + " %");
                                //$('#text_lettering').text(data[i].base);
                            }
                        }
                    },
                    fail:

                        function (data) {
                            let obj = jQuery.parseJSON(data);
                            for (i in obj) {
                                $('#text_lettering').text(data[i].base);
                            }
                            //$('#text_lettering').text(data);
                        }
                });
                //}
                //alert("Handler for .submit() called.");
            });
        });

        var percentColors = [
            {pct: 0.0, color: {r: 0xff, g: 0x00, b: 0}},
            {pct: 0.5, color: {r: 0xff, g: 0x80, b: 0}},
            {pct: 1.0, color: {r: 0xff, g: 0xff, b: 0}}];

        var getColorForPercentage = function (pct) {
            pct = 1.0 - pct;
            for (var i = 1; i < percentColors.length - 1; i++) {
                if (pct < percentColors[i].pct) {
                    break;
                }
            }
            var lower = percentColors[i - 1];
            var upper = percentColors[i];
            var range = upper.pct - lower.pct;
            var rangePct = (pct - lower.pct) / range;
            var pctLower = 1 - rangePct;
            var pctUpper = rangePct;
            var color = {
                r: Math.floor(lower.color.r * pctLower + upper.color.r * pctUpper),
                g: Math.floor(lower.color.g * pctLower + upper.color.g * pctUpper),
                b: Math.floor(lower.color.b * pctLower + upper.color.b * pctUpper)
            };
            return 'rgb(' + [color.r, color.g, color.b].join(',') + ')';
            // or output as hex if preferred
        };

        /*for (var i = 0, l = $('#text_lettering').text().length; i <= l; i++) {
            let curr_char = $(".char" + (i + 1));
            curr_char.css("background-color", getColorForPercentage(i / l));
            curr_char.css("color", "gray");
            curr_char.attr('title', (i / l));
            //$(".text_lettering").append(li);
        }*/
    </script>

    <h2 class="subtitle">
        Your Result:
    </h2>

    <h3 class="subtitle">
        Homopolymers:
    </h3>
    <ul class="text_lettering" id="text_lettering" style="overflow-x: auto;"></ul>


    <h3 class="subtitle">
        GC-Content:
    </h3>
    <ul class="text_lettering" id="gccontent" style="overflow-x: auto;"></ul>


    <!--{{ apikey }}-->

{% endblock %}