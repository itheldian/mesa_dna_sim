<!-- templates/profile.html -->

{% extends "base.html" %}


{% block content %}
    <!--<script type="text/javascript">
        function checkPass() {
            //Store the password field objects into variables ...
            var password = document.getElementById('new_password');
            var confirm = document.getElementById('new_password2');
            //Store the Confirmation Message Object ...
            var message = document.getElementById('confirm-message2');
            //Set the colors we will be using ...
            var good_color = "#66cc66";
            var bad_color = "#ff6666";
            //Compare the values in the password field
            //and the confirmation field
            if (password.value == confirm.value) {
                //The passwords match.
                //Set the color to the good color and inform
                //the user that they have entered the correct password
                confirm.style.backgroundColor = good_color;
                message.style.color = good_color;
                message.innerHTML = '<img src="/wp-content/uploads/2019/04/tick.png" alt="Passwords Match!">';
                return true;
            } else {
                //The passwords do not match.
                //Set the color to the bad color and
                //notify the user.
                confirm.style.backgroundColor = bad_color;
                message.style.color = bad_color;
                message.innerHTML = '<img src="/wp-content/uploads/2019/04/publish_x.png" alt="Passwords Do Not Match!">';
                return false;
            }
        }
    </script>-->
    <h3 class="title">Undesired Subsequences</h3>

    <hr/>
    <br/>

    <div>Your custom undesired Subsequences:</div>
    <!--<input type="checkbox" id="spoiler1"/>
    <label style="white-space: nowrap;" for="spoiler1">Show API-Key(s)</label>

     class="spoiler"-->

    <div class="box is-large">
        <form method="POST" action="{{ url_for('main_page.undesired_subsequences') }}">
            <div class="field">
                <div class="control">
                    <div class="control" id="existing_subseqs">
                        {% for subsequence in usubsequence %}
                            <div class="control has-padding-03" id="subseq_{{ subsequence.id }}">
                                <table>
                                    <tr>
                                        <td style="width:53%"><label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded" type="text"
                                                   name="sequence"
                                                   placeholder="" size="50" value="{{ subsequence.sequence }}"
                                                   required><span>Sequence</span></label></td>
                                        <td style="width:15%"><label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded" type="number"
                                                   name="error_prob"
                                                   placeholder="" size="30"
                                                   value="{{ subsequence.error_prob }}"
                                                   required min="0.0"
                                                   max="1.0" step="0.01"><span><nobr>Error Probability</nobr></span></label>
                                        </td>
                                        <td style="width:15%"><label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   type="text" name="description" placeholder="Description"
                                                   size="20"
                                                    {% if subsequence.description != None %}
                                                   value="{{ subsequence.description }}"
                                                    {% endif %}
                                                   required><span>Description</span></label></td>
                                        <td style="width:7%"><label class="checkbox">Validated: <input
                                                type="checkbox" id="validated_{{ subsequence.id }}"
                                                value="{{ subsequence.id }}"
                                                disabled
                                                {% if subsequence.validated %} checked {% endif %}/></label></td>
                                        <td style="width:5%">
                                            <button class="button"
                                                    data-balloon="Updating will remove the Validation!"
                                                    data-balloon-pos="up" id="update_subseq_{{ subsequence.id }}"
                                                    onclick="updateSeq({{ subsequence.id }}); return false;">Update
                                            </button>
                                        </td>
                                        <td style="width:5%">
                                            <button class="button" id="delete_subseq_{{ subsequence.id }}"
                                                    data-balloon="Created at: "
                                                    data-balloon-pos="up"
                                                    onclick="deleteSeq({{ subsequence.id }}); return false;">Delete
                                            </button>
                                        </td>
                                    </tr>
                                </table>
                            </div>

                        {% endfor %}
                    </div>
                    <div class="control" id="add_subseq">
                        <table>
                            <tr>
                                <td style="width:55%"><label class="form-group has-float-label">
                                    <input class="input is-rounded" type="text" id="addsequence" name="sequence"
                                           placeholder="Undesired Subsequence" size="58" value=""
                                           required><span>Sequence</span></label></td>
                                <td style="width:15%"><label class="form-group has-float-label">
                                    <input class="input is-rounded" type="number" id="errorprob" name="error_prob"
                                           placeholder="0,5" size="30" value="" required min="0.0"
                                           max="1.0" step="0.01"><span><nobr>Error Probability</nobr></span></label>
                                </td>
                                <td style="width:29%"><label class="form-group has-float-label">
                                    <input class="input is-rounded" type="text" id="description" name="description"
                                           placeholder="Description" size="31" value=""
                                           required><span>Description</span></label>
                                </td>
                                <br/>
                                <td style="width:1%">
                                    <button class="button" id="add_new_subseq">Add</button>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <!--<button class="button is-block is-info is-large is-fullwidth" id="update">Update</button>-->
        </form>
    </div>
    <div class="box is-large">
        <form method="POST" action="{{ url_for('main_page.undesired_subsequences') }}">
            <div class="field">
                <div class="control">
                    <div class="control columns is-multiline" id="synthesis_errors">
                        {% for error_id in synthesis_errors %}
                            <div class="column is-full">
                                <label class="form-group has-float-label">
                                    <input style="width:100%" class="input is-rounded"
                                           type="text" name="description" placeholder="Description"
                                           size="20"
                                            {% if synthesis_errors[error_id].data != None %}
                                           value="{{ synthesis_errors[error_id].data }}"
                                            {% endif %}
                                           required><span>Description</span></label>
                            </div>
                            <div class="control column is-one-third has-padding-03"
                                 id="synth_error_deletion_{{ synthesis_errors[error_id].id }}">
                                <div class="column has-horizontal-padding-0">
                                    <div class="button-fill sliders noUi-target noUi-ltr noUi-horizontal"
                                         id="synth-slider-deletion-{{ synthesis_errors[error_id].id }}"
                                         data-eid="{{ synthesis_errors[error_id].id }}" data-etype="deletion">
                                    </div>
                                </div>

                                <div class="columns">
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_deletion_A_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="A" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>A</span></label>
                                    </div>
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_deletion_C_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="C" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>C</span></label>
                                    </div>
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_deletion_G_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="G" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>G</span></label>
                                    </div>
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_deletion_T_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="T" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>T</span></label>
                                    </div>
                                </div>
                            </div>

                            <div class="control column is-one-third has-padding-03"
                                 id="synth_error_insertion_{{ synthesis_errors[error_id].id }}">
                                <div class="column has-horizontal-padding-0">
                                    <div class="button-fill sliders noUi-target noUi-ltr noUi-horizontal"
                                         id="synth-slider-insertion-{{ synthesis_errors[error_id].id }}"
                                         data-eid="{{ synthesis_errors[error_id].id }}" data-etype="insertion">
                                    </div>
                                </div>

                                <div class="columns">
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_insertion_A_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="A" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>A</span></label>
                                    </div>
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_insertion_C_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="C" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>C</span></label>
                                    </div>
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_insertion_G_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="G" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>G</span></label>
                                    </div>
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_insertion_T_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="T" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>T</span></label>
                                    </div>
                                </div>
                            </div>

                            <div class="control column is-one-third has-padding-03"
                                 id="synth_error_mismatch_{{ synthesis_errors[error_id].id }}">
                                <div class="column has-horizontal-padding-0">
                                    <div class="button-fill sliders noUi-target noUi-ltr noUi-horizontal"
                                         id="synth-slider-mismatch-{{ synthesis_errors[error_id].id }}"
                                         data-eid="{{ synthesis_errors[error_id].id }}" data-etype="mismatch">
                                    </div>
                                </div>

                                <div class="columns">
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_mismatch_A_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="A" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>A</span></label>
                                    </div>
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_mismatch_C_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="C" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>C</span></label>
                                    </div>
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_mismatch_G_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="G" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>G</span></label>
                                    </div>
                                    <div class="column is-one-quarter">
                                        <label class="form-group has-float-label">
                                            <input style="width:100%" class="input is-rounded"
                                                   id="synth_error_mismatch_T_{{ synthesis_errors[error_id].id }}"
                                                   type="number" name="description" placeholder="T" step="0.01"
                                                   min="0.00" max="100.00"
                                                   required><span>T</span></label>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-full"></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block javascript %}
    {{ super() }}
    {% if config['DEBUG'] or config['TESTING'] %}
        <script src={{ url_for('static',filename='js/nouislider.min.js') }}></script>
        <script src={{ url_for('static',filename='js/ajax-api.js') }}></script>
    {% endif %}
    <script>

        function deleteSeq(id) {
            $.post({
                url: "http://{{ host }}/api/delete_subsequence",
                data: {sequence_id: id, do_delete: true},
                async: true,
                beforeSend: function (xhr) {
                    if (xhr && xhr.overrideMimeType) {
                        xhr.overrideMimeType('application/json;charset=utf-8');
                    }
                },
                dataType: 'json',
                success: function (data) {
                    if (data.did_succeed) {
                        let toRemove = $('#subseq_' + data.deleted_id);
                        toRemove.remove()
                    } else {
                        console.log("Error while deleting Sequence " + id);
                    }
                },
                fail: function (data) {
                    console.log("Error while deleting Sequence" + id);
                    //$('#text_lettering').text(data);
                }
            });
        }

        $('[id^="delete_subseq_"]').each(function () {
            $(this).click(function (event) {
                event.preventDefault();
            });
        });

        function updateSeq(id) {
            let curr_subseq = $('#subseq_' + id);
            let sequence = curr_subseq.children().find("[name='sequence']");
            let error_prob = curr_subseq.children().find("[name='error_prob']");
            let desc = curr_subseq.children().find("[name='description']");
            $.post({
                url: "http://{{ host }}/api/update_subsequence",
                data: {
                    sequence_id: id,
                    sequence: sequence.val(),
                    error_prob: error_prob.val(),
                    description: desc.val()
                },
                async: true,
                beforeSend: function (xhr) {
                    if (xhr && xhr.overrideMimeType) {
                        xhr.overrideMimeType('application/json;charset=utf-8');
                    }
                },
                dataType: 'json',
                success: function (data) {
                    console.log("Update successful for id=")
                },
                fail: function (data) {
                    console.log("Update failed for id=" + id);
                    //$('#text_lettering').text(data);
                }
            });
        }

        $('[id^="update_subseq_"]').each(function () {
            $(this).click(function (event) {
                event.preventDefault();
            });
        });


        $('#add_new_subseq').click(function (event) {
            event.preventDefault();
            let sequence = $('#addsequence').val();
            let error_prob = $('#errorprob').val();
            let description = $('#description').val();
            $.post({
                url: "http://{{ host }}/api/add_subsequence",
                data: {sequence: sequence, error_prob: error_prob, description: description},
                async: true,
                beforeSend: function (xhr) {
                    if (xhr && xhr.overrideMimeType) {
                        xhr.overrideMimeType('application/json;charset=utf-8');
                    }
                },
                dataType: 'json',
                success: function (data) {
                    if (data.did_succeed) {
                        let subseq_box = $('#existing_subseqs');
                        let dattime = new Date(data.created * 1000).toUTCString();
                        subseq_box.append("<div class=\"control has-padding-03\" id=\"subseq_" + data.id + "\">\n" +
                            "<table>\n" +
                            "<tr>\n" +
                            "<td style=\"width:53%\"><label class=\"form-group has-float-label\"><input style=\"width:100%\" class=\"input is-rounded\" type=\"text\" name=\"sequence\"\n" +
                            "placeholder=\"\" size=\"50\" value=\"" + data.sequence + "\" required><span>Sequence</span></label></td>\n" +
                            "<td  style=\"width:15%\"><label class=\"form-group has-float-label\"><input style=\"width:100%\" class=\"input is-rounded\" type=\"number\" name=\"error_prob\"\n" +
                            "placeholder=\"\" size=\"30\" value=\"" + data.error_prob + "\" required\n" +
                            "min=\"0.0\"\n" +
                            "max=\"1.0\" step=\"0.01\"><span><nobr>Errpr Probability</nobr></span></label></td>\n" +
                            "<td  style=\"width:15%\"><label class=\"form-group has-float-label\"><input style=\"width:100%\" class=\"input is-rounded\" type=\"text\" name=\"description\"\n" +
                            "placeholder=\"Description\" value=\"" + data.description + "\" size=\"20\" value=\"\"\n" +
                            "required><span>Description</span></label></td>" +
                            "<td  style=\"width:7%\"> Validated: <input type=\"checkbox\" id=\"validated_" + data.id + "\"\n" +
                            "value=\"" + data.id + "\" disabled\n" + "/></td >\n" +
                            "<td style=\"width:5%\"><button class=\"button\" data-balloon=\"Updating will remove the Validation!\"\n" +
                            "data-balloon-pos=\"up\" id=\"update_subseq_" + data.id + "\"\n" +
                            "onclick=\"updateSeq(" + data.id + "); return false;\"> Update<\/button>" +
                            "<\/td>" +
                            "<td style=\"width:5%\">\n" +
                            "<button class=\"button\" id=\"delete_subseq_" + data.id + "\" data-balloon=\"Delete this Subsequence created at: " + dattime + "\"" +
                            "data-balloon-pos=\"up\" onclick=\"deleteSeq(" + data.id + "); return false;\">Delete\n" +
                            "</button>\n" +
                            "</td>\n" +
                            "</tr>\n" +
                            "</table>\n" +
                            "<br/><\/div>"
                        ).fadeIn(400)
                        ;
                        $('#addsequence').val('');
                        $('#errorprob').val('');
                        $('#description').val('');
                    } else {
                        console.log("Error while adding new Sequence ");
                    }
                },
                fail: function (data) {
                    console.log("Error while adding new Sequence");
                    //$('#text_lettering').text(data);
                }
            })
            ;
        });

        {% for subsequence in usubsequence %}
            let dattim_{{ subsequence.id }} = new Date({{ subsequence.created }} * 1000
            ).toUTCString();
            $('#delete_subseq_{{ subsequence.id }}').attr('data-balloon', "Created at: " + dattim_{{ subsequence.id }});
        {% endfor %}

        let synthesis_errors = {{ synthesis_errors|tojson|safe }};
        $('[id^="synth-slider"]').each(function () {
            let tmp = $(this)[0];
            let etype = tmp.getAttribute('data-etype');
            let eid = tmp.getAttribute('data-eid');
            let pattern = synthesis_errors[eid].err_attributes[etype].pattern;
            let startvar = [25, 50, 75];
            if (pattern !== undefined) {
                startvar = [pattern.A * 100, (pattern.A + pattern.C) * 100, (pattern.A + pattern.C + pattern.G) * 100];
            }
            noUiSlider.create($(this)[0], {
                start: startvar, // T MUST be the remainder
                connect: [true, true, true, true],
                tooltips: [true, true, true],
                behaviour: 'drag',
                range: {
                    'min': 0,
                    'max': 100
                },
            });

            tmp.noUiSlider.on('update', function (values, handle) {
                //if (handle) {
                $('#synth_error_' + etype + "_A_" + eid)[0].value = round(values[0] - 0, 4);
                $('#synth_error_' + etype + "_C_" + eid)[0].value = round(values[1] - values[0], 4);
                $('#synth_error_' + etype + "_G_" + eid)[0].value = round(values[2] - values[1], 4);
                $('#synth_error_' + etype + "_T_" + eid)[0].value = round(100.0 - values[2], 4);
                //}
            });

            $('#synth_error_' + etype + "_A_" + eid)[0].addEventListener('change', function () {
                tmp.noUiSlider.set([this.value, null, null]);
            });

            $('#synth_error_' + etype + "_C_" + eid)[0].addEventListener('change', function () {

                tmp.noUiSlider.set([null, parseFloat(this.value) + parseFloat(tmp.noUiSlider.get()[0]), null]);
            });

            $('#synth_error_' + etype + "_G_" + eid)[0].addEventListener('change', function () {
                tmp.noUiSlider.set([null, null, parseFloat(this.value) + parseFloat(tmp.noUiSlider.get()[1])]);
            });

            $('#synth_error_' + etype + "_T_" + eid)[0].addEventListener('change', function () {
                tmp.noUiSlider.set([null, null, 100.00 - parseFloat(this.value)]);
            });


            var connect = $(this)[0].querySelectorAll('.noUi-connect');
            var classes = ['c-1-color', 'c-2-color', 'c-3-color', 'c-4-color', 'c-5-color'];

            for (var i = 0; i < connect.length; i++) {
                connect[i].classList.add(classes[i]);
            }
        });

    </script>
{% endblock %}